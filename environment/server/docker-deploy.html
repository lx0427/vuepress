<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>项目部署 | Litter Flying Bears</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/vuepress/favicon.ico">
    <meta name="description" content="Litter Flying Bears">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.8b010f45.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.32252c8f.js" as="script"><link rel="preload" href="/vuepress/assets/js/2.50fecea5.js" as="script"><link rel="preload" href="/vuepress/assets/js/22.adeb73d8.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.9fe8ad4a.js"><link rel="prefetch" href="/vuepress/assets/js/11.04865b28.js"><link rel="prefetch" href="/vuepress/assets/js/12.a6451185.js"><link rel="prefetch" href="/vuepress/assets/js/13.9436dbc1.js"><link rel="prefetch" href="/vuepress/assets/js/14.e48af834.js"><link rel="prefetch" href="/vuepress/assets/js/15.c7193623.js"><link rel="prefetch" href="/vuepress/assets/js/16.38b2e471.js"><link rel="prefetch" href="/vuepress/assets/js/17.fe4cdf9b.js"><link rel="prefetch" href="/vuepress/assets/js/18.2209f5bf.js"><link rel="prefetch" href="/vuepress/assets/js/19.e89ee3e6.js"><link rel="prefetch" href="/vuepress/assets/js/20.31c1c26b.js"><link rel="prefetch" href="/vuepress/assets/js/21.2a3edce9.js"><link rel="prefetch" href="/vuepress/assets/js/23.da646f3f.js"><link rel="prefetch" href="/vuepress/assets/js/24.5c91ca5e.js"><link rel="prefetch" href="/vuepress/assets/js/25.e6ce3cf7.js"><link rel="prefetch" href="/vuepress/assets/js/26.aa3caf10.js"><link rel="prefetch" href="/vuepress/assets/js/27.1cbf3206.js"><link rel="prefetch" href="/vuepress/assets/js/28.bc8d1bdf.js"><link rel="prefetch" href="/vuepress/assets/js/29.eca8b935.js"><link rel="prefetch" href="/vuepress/assets/js/3.b5382c14.js"><link rel="prefetch" href="/vuepress/assets/js/30.d58145bc.js"><link rel="prefetch" href="/vuepress/assets/js/31.372ed51e.js"><link rel="prefetch" href="/vuepress/assets/js/32.a9759a5c.js"><link rel="prefetch" href="/vuepress/assets/js/33.e50316f0.js"><link rel="prefetch" href="/vuepress/assets/js/34.1776acfd.js"><link rel="prefetch" href="/vuepress/assets/js/35.5608e3b8.js"><link rel="prefetch" href="/vuepress/assets/js/36.e3515f2e.js"><link rel="prefetch" href="/vuepress/assets/js/37.e1fed737.js"><link rel="prefetch" href="/vuepress/assets/js/38.677e76b2.js"><link rel="prefetch" href="/vuepress/assets/js/39.e7c4a835.js"><link rel="prefetch" href="/vuepress/assets/js/4.fd890c47.js"><link rel="prefetch" href="/vuepress/assets/js/40.18410048.js"><link rel="prefetch" href="/vuepress/assets/js/41.2f5c97d8.js"><link rel="prefetch" href="/vuepress/assets/js/42.7137b413.js"><link rel="prefetch" href="/vuepress/assets/js/43.f297ecda.js"><link rel="prefetch" href="/vuepress/assets/js/44.2a8b7a5e.js"><link rel="prefetch" href="/vuepress/assets/js/45.a842db77.js"><link rel="prefetch" href="/vuepress/assets/js/46.9ee55fce.js"><link rel="prefetch" href="/vuepress/assets/js/47.6a1a8685.js"><link rel="prefetch" href="/vuepress/assets/js/48.bf378b6c.js"><link rel="prefetch" href="/vuepress/assets/js/49.3ffffef7.js"><link rel="prefetch" href="/vuepress/assets/js/5.335805b8.js"><link rel="prefetch" href="/vuepress/assets/js/50.b614f86e.js"><link rel="prefetch" href="/vuepress/assets/js/51.0ec791a3.js"><link rel="prefetch" href="/vuepress/assets/js/52.15d463d5.js"><link rel="prefetch" href="/vuepress/assets/js/53.724e7b40.js"><link rel="prefetch" href="/vuepress/assets/js/54.082cd71b.js"><link rel="prefetch" href="/vuepress/assets/js/55.00caea52.js"><link rel="prefetch" href="/vuepress/assets/js/56.7513262c.js"><link rel="prefetch" href="/vuepress/assets/js/57.ff3594c0.js"><link rel="prefetch" href="/vuepress/assets/js/58.68433a60.js"><link rel="prefetch" href="/vuepress/assets/js/59.128d4f47.js"><link rel="prefetch" href="/vuepress/assets/js/6.64b24de5.js"><link rel="prefetch" href="/vuepress/assets/js/60.de284080.js"><link rel="prefetch" href="/vuepress/assets/js/61.fa39da89.js"><link rel="prefetch" href="/vuepress/assets/js/62.7e4d8f68.js"><link rel="prefetch" href="/vuepress/assets/js/63.edcfb712.js"><link rel="prefetch" href="/vuepress/assets/js/64.5ff4a1e2.js"><link rel="prefetch" href="/vuepress/assets/js/65.d9c7493f.js"><link rel="prefetch" href="/vuepress/assets/js/66.e0a1a9c8.js"><link rel="prefetch" href="/vuepress/assets/js/67.d5f410ce.js"><link rel="prefetch" href="/vuepress/assets/js/68.c4f05a5f.js"><link rel="prefetch" href="/vuepress/assets/js/69.e7f9feb9.js"><link rel="prefetch" href="/vuepress/assets/js/7.e8b8b880.js"><link rel="prefetch" href="/vuepress/assets/js/70.ac15d52f.js"><link rel="prefetch" href="/vuepress/assets/js/71.d0c3292f.js"><link rel="prefetch" href="/vuepress/assets/js/72.009f579b.js"><link rel="prefetch" href="/vuepress/assets/js/73.c5aca37a.js"><link rel="prefetch" href="/vuepress/assets/js/74.c413f4c3.js"><link rel="prefetch" href="/vuepress/assets/js/75.f846ea4d.js"><link rel="prefetch" href="/vuepress/assets/js/76.efb1ce1a.js"><link rel="prefetch" href="/vuepress/assets/js/77.daf4df8d.js"><link rel="prefetch" href="/vuepress/assets/js/78.dd055d36.js"><link rel="prefetch" href="/vuepress/assets/js/79.ade7bfc5.js"><link rel="prefetch" href="/vuepress/assets/js/8.238ad89d.js"><link rel="prefetch" href="/vuepress/assets/js/80.a503a1b8.js"><link rel="prefetch" href="/vuepress/assets/js/81.45405473.js"><link rel="prefetch" href="/vuepress/assets/js/82.e0d795b2.js"><link rel="prefetch" href="/vuepress/assets/js/83.e10df983.js"><link rel="prefetch" href="/vuepress/assets/js/84.fdc5373b.js"><link rel="prefetch" href="/vuepress/assets/js/85.26ec28fb.js"><link rel="prefetch" href="/vuepress/assets/js/86.8df9c62c.js"><link rel="prefetch" href="/vuepress/assets/js/87.a7542c89.js"><link rel="prefetch" href="/vuepress/assets/js/88.9924c2d5.js"><link rel="prefetch" href="/vuepress/assets/js/89.0447c85e.js"><link rel="prefetch" href="/vuepress/assets/js/9.5f2817a2.js"><link rel="prefetch" href="/vuepress/assets/js/90.e7e12e32.js"><link rel="prefetch" href="/vuepress/assets/js/91.056e9725.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.8b010f45.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Litter Flying Bears</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress/css/issue.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/vuepress/database/mongodb/mongoose.html" class="nav-link">
  database
</a></div><div class="nav-item"><a href="/vuepress/environment/server/docker.html" class="nav-link">
  environment
</a></div><div class="nav-item"><a href="/vuepress/grammar/linux.html" class="nav-link">
  grammar
</a></div><div class="nav-item"><a href="/vuepress/javascript/issue.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/vuepress/node/egg/egg.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/vuepress/record/hy/develop.html" class="nav-link">
  常用记录
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress/css/issue.html" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/vuepress/database/mongodb/mongoose.html" class="nav-link">
  database
</a></div><div class="nav-item"><a href="/vuepress/environment/server/docker.html" class="nav-link">
  environment
</a></div><div class="nav-item"><a href="/vuepress/grammar/linux.html" class="nav-link">
  grammar
</a></div><div class="nav-item"><a href="/vuepress/javascript/issue.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/vuepress/node/egg/egg.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/vuepress/record/hy/develop.html" class="nav-link">
  常用记录
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>tool</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/environment/tool/git.html" class="sidebar-link">git</a></li><li><a href="/vuepress/environment/tool/node.html" class="sidebar-link">node</a></li><li><a href="/vuepress/environment/tool/npm.html" class="sidebar-link">npm</a></li><li><a href="/vuepress/environment/tool/nginx.html" class="sidebar-link">nginx</a></li><li><a href="/vuepress/environment/tool/nvm.html" class="sidebar-link">nvm</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>server</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/environment/server/ab.html" class="sidebar-link">ab</a></li><li><a href="/vuepress/environment/server/docker.html" class="sidebar-link">docker</a></li><li><a href="/vuepress/environment/server/docker-deploy.html" aria-current="page" class="active sidebar-link">docker 部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#服务器连接" class="sidebar-link">服务器连接</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#node-最新版环境安装" class="sidebar-link">node 最新版环境安装</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#docker-环境" class="sidebar-link">docker 环境</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#docker-compose-环境" class="sidebar-link">docker-compose 环境</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#其他环境" class="sidebar-link">其他环境</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#项目代码" class="sidebar-link">项目代码</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#配置文件" class="sidebar-link">配置文件</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#配置管理" class="sidebar-link">配置管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#mongodb-key" class="sidebar-link">mongodb.key</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#redis-conf" class="sidebar-link">redis.conf</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#nginx-conf" class="sidebar-link">nginx.conf</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#docker-compose-yml" class="sidebar-link">docker-compose.yml</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#副本集" class="sidebar-link">副本集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#初始化副本集" class="sidebar-link">初始化副本集</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#导入数据库" class="sidebar-link">导入数据库</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#服务启动" class="sidebar-link">服务启动</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#问题列表" class="sidebar-link">问题列表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#多文档事务报错" class="sidebar-link">多文档事务报错</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#docker-status-异常" class="sidebar-link">docker status 异常</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#docker-compose-自启动" class="sidebar-link">docker-compose 自启动</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#linux-自启动设置" class="sidebar-link">linux 自启动设置</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#docker-compose-sh" class="sidebar-link">docker-compose.sh</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#pm2" class="sidebar-link">pm2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#自启动设置" class="sidebar-link">自启动设置</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#server-js" class="sidebar-link">server.js</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#pm2-config-js" class="sidebar-link">pm2.config.js</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#常用命令" class="sidebar-link">常用命令</a></li><li class="sidebar-sub-header"><a href="/vuepress/environment/server/docker-deploy.html#pm2-配置文件" class="sidebar-link">pm2 配置文件</a></li></ul></li></ul></li><li><a href="/vuepress/environment/server/kafka.html" class="sidebar-link">kafka</a></li><li><a href="/vuepress/environment/server/RabbitMQ.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/vuepress/environment/server/redis.html" class="sidebar-link">redis</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>system</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/environment/system/bat.html" class="sidebar-link">bat</a></li><li><a href="/vuepress/environment/system/mddir.html" class="sidebar-link">mddir</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>edito</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/environment/edito/powerdesigner.html" class="sidebar-link">powerdesigner</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="项目部署"><a href="#项目部署" class="header-anchor">#</a> 项目部署</h1> <h2 id="服务器连接"><a href="#服务器连接" class="header-anchor">#</a> 服务器连接</h2> <ul><li>ip: source /etc/profile</li> <li>port: 22</li> <li>username: root</li> <li>password: @Zzyiy0521</li> <li>method: Public Key</li> <li>centos: 8.3</li></ul> <h2 id="node-最新版环境安装"><a href="#node-最新版环境安装" class="header-anchor">#</a> node 最新版环境安装</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://nodejs.org/dist/v12.19.0/node-v12.19.0-linux-x64.tar.xz
<span class="token function">tar</span> xf node-v12.19.0-linux-x64.tar.xz

<span class="token builtin class-name">cd</span> node-v12.19.0-linux-x64/
<span class="token comment"># 备份</span>
<span class="token function">cp</span> /etc/profile /etc/profile.bak
<span class="token function">vim</span> /etc/profile
<span class="token comment"># 找到export PATH，在下方插入</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/root/node-v12.19.0-linux-x64/bin
<span class="token comment"># 退出编辑</span>
<span class="token comment"># 立即生效路径配置</span>
<span class="token builtin class-name">source</span> /etc/profile

<span class="token function">npm</span> i -g <span class="token function">npm</span>
<span class="token comment"># permission denied, mkdir '/root/gamemart/egg/node_modules/bcrypt/.node-gyp'</span>
<span class="token function">npm</span> -g config <span class="token builtin class-name">set</span> user root

<span class="token comment"># cnpm</span>
<span class="token function">npm</span> i -g cnpm
<span class="token comment"># cnpm: command not found 创建软连接</span>
<span class="token function">sudo</span> <span class="token function">ln</span> -s /root/node-v12.14.0-linux-x64/bin/cnpm /usr/local/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="docker-环境"><a href="#docker-环境" class="header-anchor">#</a> docker 环境</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># requires containerd.io &gt;= 1.2.2-3, but none of the providers can be installed</span>
<span class="token function">wget</span> https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.1.el7.x86_64.rpm
yum -y <span class="token function">install</span> ./containerd.io-1.2.13-3.1.el7.x86_64.rpm

<span class="token comment"># 安装</span>
<span class="token function">curl</span> -fsSL https://get.docker.com <span class="token operator">|</span> <span class="token function">bash</span> -s docker --mirror Aliyun
docker -v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="docker-compose-环境"><a href="#docker-compose-环境" class="header-anchor">#</a> docker-compose 环境</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 安装</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L <span class="token string">&quot;https://github.com/docker/compose/releases/download/1.27.4/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span>&quot;</span> -o /usr/local/bin/docker-compose

<span class="token comment"># /usr/local/bin/docker-compose: Permission denied</span>
<span class="token function">chmod</span> +x /usr/local/bin/docker-compose

docker-compose -v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="其他环境"><a href="#其他环境" class="header-anchor">#</a> 其他环境</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker pull nginx:latest
docker pull redis:latest
docker pull mongo:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="项目代码"><a href="#项目代码" class="header-anchor">#</a> 项目代码</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> -p /root/gamemart
<span class="token builtin class-name">cd</span> /root/gamemart/
<span class="token function">mkdir</span> admin
<span class="token function">mkdir</span> egg
<span class="token function">mkdir</span> mobile
<span class="token comment"># /root/gamemart/</span>
<span class="token comment"># ├── admin</span>
<span class="token comment"># ├── egg</span>
<span class="token comment"># └── mobile</span>

<span class="token comment"># 上传项目代码</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> -p /data/gamemart
<span class="token comment"># /data/gamemart</span>
<span class="token comment"># ├── docker-compose.yml</span>
<span class="token comment"># ├── mongodb.key</span>
<span class="token comment"># ├── nginx</span>
<span class="token comment"># │   ├── admin</span>
<span class="token comment"># │   │   └── nginx.conf</span>
<span class="token comment"># │   ├── mobile</span>
<span class="token comment"># │   │   └── nginx.conf</span>
<span class="token comment"># └── redis</span>
<span class="token comment">#     └── redis.conf</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="配置管理"><a href="#配置管理" class="header-anchor">#</a> 配置管理</h2> <h3 id="mongodb-key"><a href="#mongodb-key" class="header-anchor">#</a> mongodb.key</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建秘钥 mongodb.key</span>
openssl rand -base64 <span class="token number">756</span> <span class="token operator">&gt;</span> mongodb.key
<span class="token function">chmod</span> <span class="token number">400</span> mongodb.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="redis-conf"><a href="#redis-conf" class="header-anchor">#</a> redis.conf</h3> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>requirepass 123456
#daemonize yes
bind 0.0.0.0
appendonly yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="nginx-conf"><a href="#nginx-conf" class="header-anchor">#</a> nginx.conf</h3> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>#user  nginx;
worker_processes  1;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
    worker_connections  1024;
}
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '
                      '$status $body_bytes_sent &quot;$http_referer&quot; '
                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';
    access_log  /var/log/nginx/access.log  main;
    client_max_body_size 10m;
    sendfile        on;
    #tcp_nopush     on;
    keepalive_timeout  65;
    #gzip  on;
    server {
        listen       8081;
        server_name  localhost;
        root         /webserver;
        location / {
            try_files $uri $uri/ /index.html;
            index  index.html index.htm;
        }
        location @router {
          rewrite ^.*$ /index.html last;
        }
    }
    include /etc/nginx/conf.d/*.conf;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="header-anchor">#</a> docker-compose.yml</h3> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.12'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gamemart_redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gamemart_redis
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 6379<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./redis/redis.conf<span class="token punctuation">:</span>/etc/redis/redis.conf<span class="token punctuation">:</span>rw
      <span class="token punctuation">-</span> ./redis/data<span class="token punctuation">:</span>/data<span class="token punctuation">:</span>rw
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server /etc/redis/redis.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes

  <span class="token key atrule">admin</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8081<span class="token punctuation">:</span><span class="token number">8081</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /root/gamemart/admin<span class="token punctuation">:</span>/webserver
      <span class="token punctuation">-</span> ./nginx/admin/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> ./nginx/admin/log<span class="token punctuation">:</span>/var/log/nginx
  <span class="token key atrule">mobile</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mobile
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /root/gamemart/mobile<span class="token punctuation">:</span>/webserver
      <span class="token punctuation">-</span> ./nginx/mobile/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> ./nginx/mobile/log<span class="token punctuation">:</span>/var/log/nginx

  <span class="token key atrule">master</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> master
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/db/master<span class="token punctuation">:</span>/data/db
      <span class="token punctuation">-</span> ./data/db/master/log<span class="token punctuation">:</span>/data/mongo/log
      <span class="token punctuation">-</span> ./data/backup<span class="token punctuation">:</span>/data/backup
      <span class="token punctuation">-</span> ./mongodb.key<span class="token punctuation">:</span>/data/mongodb.key
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27001<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_USERNAME</span><span class="token punctuation">:</span> root
      <span class="token key atrule">MONGO_INITDB_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongoNet
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mongod <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs <span class="token punctuation">-</span><span class="token punctuation">-</span>keyFile /data/mongodb.key
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bash
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        exec docker-entrypoint.sh $$@</span>
  <span class="token key atrule">secondary</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> secondary
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/db/secondary<span class="token punctuation">:</span>/data/db
      <span class="token punctuation">-</span> ./data/db/secondary/log<span class="token punctuation">:</span>/data/mongo/log
      <span class="token punctuation">-</span> ./mongodb.key<span class="token punctuation">:</span>/data/mongodb.key
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27002<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_USERNAME</span><span class="token punctuation">:</span> root
      <span class="token key atrule">MONGO_INITDB_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongoNet
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mongod <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs <span class="token punctuation">-</span><span class="token punctuation">-</span>keyFile /data/mongodb.key
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bash
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        exec docker-entrypoint.sh $$@</span>
  <span class="token key atrule">arbiter</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> arbiter
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/db/arbiter<span class="token punctuation">:</span>/data/db
      <span class="token punctuation">-</span> ./data/db/arbiter/log<span class="token punctuation">:</span>/data/mongo/log
      <span class="token punctuation">-</span> ./mongodb.key<span class="token punctuation">:</span>/data/mongodb.key
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27003<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_USERNAME</span><span class="token punctuation">:</span> root
      <span class="token key atrule">MONGO_INITDB_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongoNet
    <span class="token key atrule">command</span><span class="token punctuation">:</span> mongod <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs <span class="token punctuation">-</span><span class="token punctuation">-</span>keyFile /data/mongodb.key
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bash
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        exec docker-entrypoint.sh $$@</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongoNet</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><h2 id="副本集"><a href="#副本集" class="header-anchor">#</a> 副本集</h2> <h3 id="初始化副本集"><a href="#初始化副本集" class="header-anchor">#</a> 初始化副本集</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 启动docker-compose</span>
docker-compose up -d
<span class="token comment"># 关闭防火墙</span>
<span class="token comment"># &quot;errmsg&quot; : &quot;No host described in new configuration with {version: 1, term: 0} for replica set rs maps to this node&quot;</span>
systemctl stop firewalld
<span class="token comment"># 进入容器</span>
docker <span class="token builtin class-name">exec</span> -it master /bin/bash
<span class="token comment"># 连接数据库</span>
mongo -uroot -p123456
<span class="token comment"># 初始化副本集</span>
rs.initiate<span class="token punctuation">(</span><span class="token punctuation">{</span> _id: <span class="token string">&quot;rs&quot;</span>, members: <span class="token punctuation">[</span><span class="token punctuation">{</span> _id: <span class="token number">0</span>, host: <span class="token string">&quot;118.27.9.229:27001&quot;</span>, priority:2 <span class="token punctuation">}</span>,<span class="token punctuation">{</span> _id: <span class="token number">1</span>, host: <span class="token string">&quot;118.27.9.229:27002&quot;</span>, priority:1 <span class="token punctuation">}</span>,<span class="token punctuation">{</span> _id: <span class="token number">2</span>, host: <span class="token string">&quot;118.27.9.229:27003&quot;</span>, arbiterOnly:true <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 强制重置配置(测试环境)</span>
rs.reconfig<span class="token punctuation">(</span><span class="token punctuation">{</span> _id: <span class="token string">&quot;rs&quot;</span>, members: <span class="token punctuation">[</span><span class="token punctuation">{</span> _id: <span class="token number">0</span>, host: <span class="token string">&quot;192.168.0.61:27001&quot;</span>, priority:2 <span class="token punctuation">}</span>,<span class="token punctuation">{</span> _id: <span class="token number">1</span>, host: <span class="token string">&quot;192.168.0.61:27002&quot;</span>, priority:1 <span class="token punctuation">}</span>,<span class="token punctuation">{</span> _id: <span class="token number">2</span>, host: <span class="token string">&quot;192.168.0.61:27003&quot;</span>, arbiterOnly:true <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>force:true<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 退出容器</span>
<span class="token builtin class-name">exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="导入数据库"><a href="#导入数据库" class="header-anchor">#</a> 导入数据库</h3> <blockquote><p>使用 studio 3T 进行导入</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 导出本地数据库</span>
mongodump -h localhost:27117 -uadmin -p123456 -d game_mall --authenticationDatabase admin -o D:<span class="token punctuation">\</span>MongoDB<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>dump
<span class="token comment"># 将数据库文件传入 /data/backup/game_mall</span>
<span class="token comment"># 进入容器</span>
docker <span class="token builtin class-name">exec</span> -it master /bin/bash
<span class="token comment"># 执行导入</span>
mongorestore -h <span class="token number">118.27</span>.9.229:27001 -uroot -p123456 --authenticationDatabase admin -d game_mall --dir /data/backup/game_mall
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="服务启动"><a href="#服务启动" class="header-anchor">#</a> 服务启动</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># docker-compose 启动</span>
<span class="token builtin class-name">cd</span> /data/gamemart
docker-compose up -d
<span class="token comment"># ERROR: Failed to Setup IP tables: Unable to enable SKIP DNAT rule</span>
<span class="token comment"># 关闭防火墙之后, docker需要重启</span>
<span class="token function">service</span> docker restart

<span class="token comment"># egg 启动</span>
<span class="token builtin class-name">cd</span> /root/gamemart/egg
<span class="token function">yarn</span> start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="问题列表"><a href="#问题列表" class="header-anchor">#</a> 问题列表</h2> <h3 id="多文档事务报错"><a href="#多文档事务报错" class="header-anchor">#</a> 多文档事务报错</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 提前创建好集合</span>
db<span class="token punctuation">.</span>order<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>log_order_status<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ip<span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="docker-status-异常"><a href="#docker-status-异常" class="header-anchor">#</a> docker status 异常</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># status: created  =&gt;  重启docker</span>
systemctl restart docker

<span class="token comment"># status: restart  =&gt;  关闭防火墙</span>
systemctl stop firewalld
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="docker-compose-自启动"><a href="#docker-compose-自启动" class="header-anchor">#</a> docker-compose 自启动</h2> <h3 id="linux-自启动设置"><a href="#linux-自启动设置" class="header-anchor">#</a> linux 自启动设置</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#编辑开机自启动脚本</span>
<span class="token function">vim</span> /etc/rc.d/init.d/docker-compose.sh
<span class="token comment"># 授权</span>
<span class="token function">chmod</span> +x /etc/rc.d/init.d/docker-compose.sh
<span class="token comment"># 开机自启动</span>
<span class="token function">chkconfig</span> docker-compose.sh on

<span class="token comment"># 开机自启动docker</span>
systemctl <span class="token builtin class-name">enable</span> docker
<span class="token comment"># 服务器重启</span>
<span class="token function">reboot</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="docker-compose-sh"><a href="#docker-compose-sh" class="header-anchor">#</a> <code>docker-compose.sh</code></h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># chkconfig: 2345 85 15</span>
<span class="token comment"># description: docker-compose init start</span>

systemctl stop firewalld
/usr/local/bin/docker-compose -f /data/gamemart/docker-compose.yml up -d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="pm2"><a href="#pm2" class="header-anchor">#</a> pm2</h2> <h3 id="自启动设置"><a href="#自启动设置" class="header-anchor">#</a> 自启动设置</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 下载</span>
<span class="token function">npm</span> i pm2 -g
<span class="token comment"># 使用生产环境启动服务</span>
pm2 start pm2.config.js --env production
<span class="token comment"># 保存当前应用列表</span>
pm2 save
<span class="token comment"># 创建开机自启动命令</span>
pm2 startup
<span class="token comment"># 重启，发现之前的服务都已经启动</span>
<span class="token function">sudo</span> systemctl <span class="token function">reboot</span>
<span class="token comment"># 删除自动启动服务</span>
<span class="token function">sudo</span> pm2 unstartup systemd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="server-js"><a href="#server-js" class="header-anchor">#</a> server.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> egg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> workers <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
egg<span class="token punctuation">.</span><span class="token function">startCluster</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  workers<span class="token punctuation">,</span>
  baseDir<span class="token operator">:</span> __dirname<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="pm2-config-js"><a href="#pm2-config-js" class="header-anchor">#</a> pm2.config.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  apps<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'gamermart-egg'</span><span class="token punctuation">,</span>
      script<span class="token operator">:</span> <span class="token string">'./server.js'</span><span class="token punctuation">,</span>
      watch<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      env<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token constant">PORT</span><span class="token operator">:</span> <span class="token number">7001</span><span class="token punctuation">,</span>
        <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      env_production<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token constant">PORT</span><span class="token operator">:</span> <span class="token number">7001</span><span class="token punctuation">,</span>
        <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>pm2 start app.js <span class="token comment"># 启动app.js应用程序</span>

pm2 start app.js -i <span class="token number">4</span>        <span class="token comment"># cluster mode 模式启动4个app.js的应用实例  4个应用程序会自动进行负载均衡</span>

pm2 start app.js --name<span class="token operator">=</span><span class="token string">&quot;api&quot;</span> <span class="token comment"># 启动应用程序并命名为 &quot;api&quot;</span>

pm2 start app.js --watch      <span class="token comment"># 当文件变化时自动重启应用</span>

pm2 start script.sh          <span class="token comment"># 启动 bash 脚本</span>

pm2 list                      <span class="token comment"># 列表 PM2 启动的所有的应用程序</span>

pm2 monit                    <span class="token comment"># 显示每个应用程序的CPU和内存占用情况</span>

pm2 show <span class="token punctuation">[</span>app-name<span class="token punctuation">]</span>          <span class="token comment"># 显示应用程序的所有信息</span>

pm2 logs                      <span class="token comment"># 显示所有应用程序的日志</span>

pm2 logs <span class="token punctuation">[</span>app-name<span class="token punctuation">]</span>          <span class="token comment"># 显示指定应用程序的日志</span>

pm2 flush                       <span class="token comment"># 清空所有日志文件</span>

pm2 stop all                  <span class="token comment"># 停止所有的应用程序</span>

pm2 stop <span class="token number">0</span>                    <span class="token comment"># 停止 id为 0的指定应用程序</span>

pm2 restart all              <span class="token comment"># 重启所有应用</span>

pm2 reload all                <span class="token comment"># 重启 cluster mode下的所有应用</span>

pm2 gracefulReload all        <span class="token comment"># Graceful reload all apps in cluster mode</span>

pm2 delete all                <span class="token comment"># 关闭并删除所有应用</span>

pm2 delete <span class="token number">0</span>                  <span class="token comment"># 删除指定应用 id 0</span>

pm2 scale api <span class="token number">10</span>              <span class="token comment"># 把名字叫api的应用扩展到10个实例</span>

pm2 reset <span class="token punctuation">[</span>app-name<span class="token punctuation">]</span>          <span class="token comment"># 重置重启数量</span>

pm2 startup                  <span class="token comment"># 创建开机自启动命令</span>

pm2 save                      <span class="token comment"># 保存当前应用列表</span>

pm2 resurrect                <span class="token comment"># 重新加载保存的应用列表</span>

pm2 update                    <span class="token comment"># Save processes, kill PM2 and restore processes</span>

pm2 generate                  <span class="token comment"># Generate a sample json configuration file</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="pm2-配置文件"><a href="#pm2-配置文件" class="header-anchor">#</a> pm2 配置文件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> day <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dayjs'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  apps<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 项目名</span>
      name<span class="token operator">:</span> <span class="token string">'server'</span><span class="token punctuation">,</span>
      <span class="token comment">// 执行文件</span>
      script<span class="token operator">:</span> <span class="token string">'./server.js'</span><span class="token punctuation">,</span>
      <span class="token comment">// 根目录</span>
      cwd<span class="token operator">:</span> <span class="token string">'./'</span><span class="token punctuation">,</span>
      <span class="token comment">// 传递给脚本的参数</span>
      args<span class="token operator">:</span> <span class="token string">'one two'</span><span class="token punctuation">,</span>
      <span class="token comment">// 指定的脚本解释器</span>
      interpreter<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token comment">// 传递给解释器的参数</span>
      interpreter_args<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token comment">// 应用启动模式，支持fork和cluster模式</span>
      exec_mode<span class="token operator">:</span> <span class="token string">'cluster_mode'</span><span class="token punctuation">,</span>
      <span class="token comment">// 应用启动实例个数，仅在cluster模式有效 默认为fork；或者 max</span>
      instances<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token comment">// 最大内存限制数，超出自动重启</span>
      max_memory_restart<span class="token operator">:</span> <span class="token string">'1G'</span><span class="token punctuation">,</span>
      <span class="token comment">// 错误日志文件</span>
      error_file<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./logs/pm2/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDD'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/app-err.log</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token comment">// 正常日志文件</span>
      out_file<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./logs/pm2/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYYMMDD'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/app-out.log</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token comment">// 设置追加日志而不是新建日志</span>
      merge_logs<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// 指定日志文件的时间格式</span>
      log_date_format<span class="token operator">:</span> <span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">,</span>
      <span class="token comment">// 应用运行少于时间被认为是异常启动</span>
      min_uptime<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token comment">// 最大异常重启次数，即小于min_uptime运行时间重启次数；</span>
      max_restarts<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
      <span class="token comment">// 默认为true, 发生异常的情况下自动重启</span>
      autorestart<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// crontab时间格式重启应用，目前只支持cluster模式;</span>
      cron_restart<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token comment">// 异常重启情况下，延时重启时间</span>
      restart_delay<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
      <span class="token comment">// 是否监听文件变动然后重启</span>
      watch<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// 不用监听的文件</span>
      ignore_watch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> <span class="token string">'news'</span><span class="token punctuation">,</span> <span class="token string">'run'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token string">'typings'</span><span class="token punctuation">,</span> <span class="token string">'pm2.config'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      env<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'development'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      env_production<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'production'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/25/2021, 5:17:26 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress/environment/server/docker.html" class="prev">
        docker
      </a></span> <span class="next"><a href="/vuepress/environment/server/kafka.html">
        kafka
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vuepress/assets/js/app.32252c8f.js" defer></script><script src="/vuepress/assets/js/2.50fecea5.js" defer></script><script src="/vuepress/assets/js/22.adeb73d8.js" defer></script>
  </body>
</html>
